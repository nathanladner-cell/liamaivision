<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Liam</title>
    <link rel="icon" type="image/png" href="/static/liamai_cropped.png">
    <link rel="icon" type="image/x-icon" href="/static/liamai_cropped.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            font-size: 1rem;
        }

        /* Global scrollbar hiding for all elements */
        *::-webkit-scrollbar {
            display: none;
        }

        * {
            -webkit-scrollbar: none;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        body {
            font-family: 'Courier New', 'Monaco', monospace;
            background: 
                radial-gradient(circle at 20% 30%, rgba(34, 139, 34, 0.08) 0%, transparent 70%),
                radial-gradient(circle at 80% 20%, rgba(0, 128, 0, 0.06) 0%, transparent 70%),
                radial-gradient(circle at 40% 80%, rgba(144, 238, 144, 0.05) 0%, transparent 75%),
                radial-gradient(circle at 90% 90%, rgba(240, 255, 240, 0.1) 0%, transparent 60%),
                linear-gradient(135deg, #ffffff 0%, rgba(240, 255, 240, 0.6) 25%, #ffffff 50%, rgba(224, 255, 224, 0.5) 75%, #ffffff 100%);
            min-height: 100vh;
            color: #000000;
            position: relative;
            overflow-x: hidden;
        }

        /* Beautiful glass background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(ellipse at 30% 20%, rgba(34, 139, 34, 0.04) 0%, transparent 60%),
                radial-gradient(ellipse at 70% 60%, rgba(0, 128, 0, 0.03) 0%, transparent 60%),
                radial-gradient(ellipse at 50% 90%, rgba(144, 238, 144, 0.02) 0%, transparent 70%),
                radial-gradient(ellipse at 90% 30%, rgba(240, 255, 240, 0.05) 0%, transparent 60%);
            animation: dreamyFlow 15s ease-in-out infinite alternate;
            z-index: -2;
        }

        @keyframes dreamyFlow {
            0% { 
                opacity: 0.4;
                transform: translateX(0px) translateY(0px) scale(1);
            }
            33% {
                opacity: 0.6;
                transform: translateX(20px) translateY(-15px) scale(1.05);
            }
            66% {
                opacity: 0.5;
                transform: translateX(-10px) translateY(10px) scale(0.98);
            }
            100% { 
                opacity: 0.7;
                transform: translateX(0px) translateY(0px) scale(1.02);
            }
        }







        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 160px 20px 20px 20px; /* Top padding for fixed header */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 40px 20px;
            color: #000000;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: transparent !important; /* Always transparent */
            backdrop-filter: none !important; /* No blur effect */
        }

        .header.scrolled {
            background: transparent !important; /* Always transparent when scrolled */
            backdrop-filter: none !important; /* No blur effect when scrolled */
        }





        .header-icon {
            width: 100px;
            height: 100px;
            margin: 0 auto 20px;
            display: block;
            border-radius: 0px;
            object-fit: contain; /* Changed from cover to contain to show full cropped logo */
            object-position: center;
            box-shadow: none;
            animation: iconFloat 4s ease-in-out infinite;
            clip-path: none;
        }

        @keyframes iconFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: #000000;
            text-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-family: 'Courier New', monospace;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.8;
            color: #666666;
            font-family: 'Courier New', monospace;
        }
        
        


        /* Chat container removed - messages float directly on background */





        .chat-messages {
            flex: 1;
            padding: 160px 20px 220px 0; /* Increased bottom padding for better spacing above input */
            overflow-y: auto;
            overflow-x: visible; /* Allow horizontal overflow for re-ask buttons */
            max-height: 100vh; /* Full viewport height */
            display: flex;
            flex-direction: column;
            position: fixed;
            background: transparent;
            width: 80%;
            max-width: none;
            margin: 0 auto;
            left: 50%;
            transform: translateX(-50%);
            top: 0; /* Start from top of screen */
            /* Hide scrollbar on desktop */
            -webkit-scrollbar: none;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Additional scrollbar hiding for webkit browsers */
        .chat-messages::-webkit-scrollbar {
            display: none;
        }

        /* Message area background removed for clean floating effect */

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
            animation: messageSlide 0.4s ease-out;
            width: 100%;
            position: relative;
            overflow: visible; /* Allow re-ask buttons to extend beyond message bounds */
        }

        /* Consistent message spacing across all devices */
        .message {
            gap: 0px; /* No gap needed without logos */
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.assistant {
            justify-content: flex-start;
            align-items: flex-start;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
            margin-top: 5px;
            position: relative;
            border: 2px solid transparent;
        }

        /* Mobile-optimized avatar size */
        @media (max-width: 480px) {
            .message-avatar {
                width: 36px;
                height: 36px;
                margin-top: 3px; /* Slightly less top margin */
            }
        }

        @media (max-width: 320px) {
            .message-avatar {
                width: 32px;
                height: 32px;
                margin-top: 2px; /* Minimal top margin */
            }
        }

        .message.user .message-avatar {
            background: linear-gradient(45deg, rgba(34, 139, 34, 0.9), rgba(144, 238, 144, 0.8));
            color: #ffffff;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 15px rgba(34, 139, 34, 0.4);
        }

        .message.assistant .message-avatar {
            background: linear-gradient(45deg, rgba(240, 255, 240, 0.9), rgba(255, 255, 255, 0.8));
            color: #228b22;
            border: 2px solid rgba(34, 139, 34, 0.2);
            box-shadow: 0 0 20px rgba(34, 139, 34, 0.3);
        }



        .message-content {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px 20px;
            border-radius: 15px;
            max-width: 70%;
            line-height: 1.6;
            box-shadow: none;
            color: #000000;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow: visible; /* Allow re-ask button to extend beyond content bounds */
            font-size: 1rem;
            font-family: 'Courier New', monospace;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            backdrop-filter: blur(10px) saturate(150%);
            -webkit-backdrop-filter: blur(10px) saturate(150%);
        }

        /* Optimized message bubble width without logos */
        .message-content {
            max-width: 85%; /* More width available without logos */
        }

        @media (max-width: 480px) {
            .message-content {
                max-width: 95%; /* Almost full width on small screens */
                padding: 12px 16px; /* Slightly smaller padding for more content space */
            }
        }

        @media (max-width: 320px) {
            .message-content {
                max-width: 98%; /* Near full width on very small screens */
                padding: 10px 14px; /* Compact padding */
            }
        }

        /* Re-ask button styles */
        .reask-button {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: rgba(34, 139, 34, 0.9);
            border: 1px solid rgba(34, 139, 34, 0.5);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            opacity: 0;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(34, 139, 34, 0.3);
            z-index: 10;
        }

        .message.user .message-content:hover .reask-button {
            opacity: 1;
        }

        .reask-button:hover {
            background: rgba(34, 139, 34, 1);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(34, 139, 34, 0.5);
        }

        .reask-button svg {
            width: 12px;
            height: 12px;
            fill: white;
        }

        .message.user .message-content {
            background: rgba(34, 139, 34, 0.2);
            color: #ffffff;
            margin-left: auto;
            border: 1px solid rgba(34, 139, 34, 0.3);
            box-shadow: 0 4px 15px rgba(34, 139, 34, 0.15);
            backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
        }

        .message.assistant .message-content {
            background: rgba(240, 255, 240, 0.25);
            border: 1px solid rgba(34, 139, 34, 0.15);
            color: #2d5a2d;
            margin-right: auto;
            box-shadow: 0 4px 15px rgba(34, 139, 34, 0.1);
            backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
        }





        /* Markdown formatting styles */
        .message-content strong,
        .message-content b {
            font-weight: bold;
            color: #000000;
        }

        .message-content em,
        .message-content i {
            font-style: italic;
            color: #333333;
        }

        .message-content code {
            background: #eeeeee;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Helvetica Neue', Helvetica, Arial, monospace;
            color: #000000;
        }

        .message-content pre {
            background: #f2f2f2;
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
            /* Hide horizontal scrollbar on code blocks */
            -webkit-scrollbar: none;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .message-content pre::-webkit-scrollbar {
            display: none;
        }

        .message-content pre code {
            background: none;
            padding: 0;
            color: #111111;
        }

        .message-content h1,
        .message-content h2,
        .message-content h3,
        .message-content h4 {
            margin: 15px 0 10px 0;
            color: #000000;
            font-weight: 600;
        }

        .message-content h1 { font-size: 1.4em; }
        .message-content h2 { font-size: 1.3em; }
        .message-content h3 { font-size: 1.2em; }
        .message-content h4 { font-size: 1.1em; }

        .message-content ul,
        .message-content ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .message-content li {
            margin: 5px 0;
        }

        .message-content blockquote {
            border-left: none;
            margin: 10px 0;
            padding-left: 15px;
            color: #555555;
            font-style: italic;
        }

        .rag-info {
            font-size: 0.85rem;
            color: #444444;
            margin-top: 8px;
            padding: 8px 12px;
            background: #f9f9f9;
            border-radius: 8px;
            border-left: none;
        }

        .chat-input-container {
            padding: 20px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: none;
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.37),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(30px) saturate(200%);
            -webkit-backdrop-filter: blur(30px) saturate(200%);
            z-index: 1000;
            transition: bottom 0.3s ease, transform 0.3s ease;
        }

        /* Mobile keyboard adjustments removed to restore basic functionality */









        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .send-button {
            background: rgba(255, 255, 255, 0.15);
            color: #000000;
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 0px;
            width: 50px;
            height: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
            box-shadow:
                0 4px 16px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(15px) saturate(150%);
            -webkit-backdrop-filter: blur(15px) saturate(150%);
            clip-path: polygon(0 0, calc(100% - 8px) 0, 100% 8px, 100% calc(100% - 8px), calc(100% - 8px) 100%, 8px 100%, 0 calc(100% - 8px));
            /* Mobile touch improvements */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }

        .send-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 50%, rgba(255, 255, 255, 0.02) 100%);
            border-radius: 0px;
            z-index: -1;
            clip-path: polygon(0 0, calc(100% - 8px) 0, 100% 8px, 100% calc(100% - 8px), calc(100% - 8px) 100%, 8px 100%, 0 calc(100% - 8px));
        }

        .send-button svg {
            width: 20px;
            height: 20px;
            display: block;
            position: relative;
            z-index: 1;
        }

        .upload-button {
            background: rgba(255, 255, 255, 0.15);
            color: #000000;
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 0px;
            width: 50px;
            height: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
            box-shadow:
                0 4px 16px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(15px) saturate(150%);
            -webkit-backdrop-filter: blur(15px) saturate(150%);
            clip-path: polygon(0 0, calc(100% - 8px) 0, 100% 8px, 100% calc(100% - 8px), calc(100% - 8px) 100%, 8px 100%, 0 calc(100% - 8px));
            /* Mobile touch improvements */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }

        .upload-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 50%, rgba(255, 255, 255, 0.02) 100%);
            border-radius: 0px;
            z-index: -1;
            clip-path: polygon(0 0, calc(100% - 8px) 0, 100% 8px, 100% calc(100% - 8px), calc(100% - 8px) 100%, 8px 100%, 0 calc(100% - 8px));
        }

        .upload-button svg {
            width: 20px;
            height: 20px;
            display: block;
            position: relative;
            z-index: 1;
        }

        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow:
                0 8px 24px rgba(0, 0, 0, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.4),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.2);
        }

        .upload-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .upload-button.has-image {
            background: rgba(34, 139, 34, 0.3);
            border-color: rgba(34, 139, 34, 0.5);
        }

        .upload-button.has-image::before {
            background: linear-gradient(135deg, rgba(34, 139, 34, 0.2) 0%, rgba(34, 139, 34, 0.1) 50%, rgba(34, 139, 34, 0.05) 100%);
        }

        /* Image preview styles - minimal */
        .image-preview-container {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 5px;
            backdrop-filter: blur(10px) saturate(150%);
            -webkit-backdrop-filter: blur(10px) saturate(150%);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 100;
        }

        .image-preview-container.show {
            display: block;
        }

        .image-preview-img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid rgba(34, 139, 34, 0.2);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .image-preview-img:hover {
            border-color: rgba(34, 139, 34, 0.5);
            transform: scale(1.05);
        }

        /* Message image styles */
        .message-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid rgba(255, 255, 255, 0.3);
            object-fit: cover;
        }

        .message-image-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }



        .chat-input {
            flex: 1;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0px;
            padding: 15px 20px;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
            resize: none;
            min-height: 50px;
            max-height: 120px;
            font-family: 'Courier New', monospace;
            background: rgba(255, 255, 255, 0.12);
            color: #000000;
            backdrop-filter: blur(15px) saturate(150%);
            -webkit-backdrop-filter: blur(15px) saturate(150%);
            position: relative;
            clip-path: polygon(0 0, calc(100% - 15px) 0, 100% 15px, 100% calc(100% - 15px), calc(100% - 15px) 100%, 15px 100%, 0 calc(100% - 15px));
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1);
        }

        .chat-input::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 50%, rgba(255, 255, 255, 0.02) 100%);
            border-radius: 0px;
            z-index: -1;
            opacity: 1;
            transition: opacity 0.3s ease;
            clip-path: polygon(0 0, calc(100% - 15px) 0, 100% 15px, 100% calc(100% - 15px), calc(100% - 15px) 100%, 15px 100%, 0 calc(100% - 15px));
        }

        .chat-input:focus {
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow:
                0 0 20px rgba(255, 255, 255, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1);
        }

        .chat-input:focus::before {
            opacity: 0.3;
        }

        .chat-input::placeholder {
            color: #666666;
            font-family: 'Courier New', monospace;
        }



        .send-button:hover {
            transform: translateY(-2px);
            box-shadow:
                0 8px 24px rgba(0, 0, 0, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.4),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.2);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }














        .typing-indicator {
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease-in;
            opacity: 1;
            transition: opacity 0.3s ease-out;
            will-change: opacity;
        }

        .typing-indicator .message {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            width: 100%;
        }

        .typing-indicator .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #111111;
            flex-shrink: 0;
            margin-top: 5px;
            background: #dddddd;
        }

        .typing-indicator .message-content {
            background: #f7f7f7;
            padding: 15px 20px;
            border-radius: 18px;
            max-width: 70%;
            line-height: 1.6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            color: #555555;
            font-style: italic;
            border: 1px solid #e6e6e6;
            margin-right: auto;
            font-size: 1rem;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #999999;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive design for adaptive scaling */
        @media (max-width: 1200px) {
            .chat-input-container {
                width: 85%;
            }
        }

        @media (max-width: 1200px) {
            .chat-input-container {
                width: 85%;
            }
            .chat-messages {
                width: 85%;
                /* Hide scrollbar on tablets */
                -webkit-scrollbar: none;
                -ms-overflow-style: none;  /* IE and Edge */
                scrollbar-width: none;  /* Firefox */
            }

            /* Additional scrollbar hiding for webkit browsers */
            .chat-messages::-webkit-scrollbar {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .chat-input-container {
                width: 90%;
                bottom: 60px;
                padding: 15px;
            }
            .chat-messages {
                width: 90%;
                padding: 100px 20px 180px 0; /* Increased bottom padding for better spacing */
                /* Hide scrollbar on mobile */
                -webkit-scrollbar: none;
                -ms-overflow-style: none;  /* IE and Edge */
                scrollbar-width: none;  /* Firefox */
            }

            /* Additional scrollbar hiding for webkit browsers */
            .chat-messages::-webkit-scrollbar {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .container { padding: 80px 10px 10px 10px; } /* Adjusted for even smaller header */
            .header { 
                padding: 15px 20px 5px 20px; /* Even smaller on small screens */
            }
            .header-icon {
                width: 50px; /* Even smaller icon */
                height: 50px;
                margin: 0 auto 5px;
            }
            .header h1 { font-size: 1.2rem; }
            .header p { font-size: 0.8rem; }
            .chat-input-container {
                width: 95%;
                bottom: 30px; /* Even less bottom spacing */
                padding: 10px; /* Smaller padding */
                min-height: 45px; /* Shorter chatbox */
                border-radius: 10px; /* Even smaller rounded corners */
            }
            
            /* Mobile keyboard adjustments for small screens */
            .chat-input-container.keyboard-open {
                bottom: 5px;
                transform: translateX(-50%) translateY(-3px);
            }
            
            .chat-input-wrapper {
                gap: 8px; /* Even smaller gap */
            }
            .send-button {
                width: 36px; /* Even smaller button */
                height: 36px;
            }
            .send-button svg {
                width: 14px; /* Even smaller icon */
                height: 14px;
            }
            .upload-button {
                width: 36px; /* Match send button size */
                height: 36px;
            }
            .upload-button svg {
                width: 14px; /* Match send button icon size */
                height: 14px;
            }
            .chat-messages {
                width: 95%;
                max-height: 100vh; /* Full viewport height */
                top: 0; /* Start from top of screen */
                padding: 80px 20px 160px 0; /* Increased bottom padding for better spacing */
                /* Hide scrollbar on mobile */
                -webkit-scrollbar: none;
                -ms-overflow-style: none;  /* IE and Edge */
                scrollbar-width: none;  /* Firefox */
            }

            /* Additional scrollbar hiding for webkit browsers */
            .chat-messages::-webkit-scrollbar {
                display: none;
            }
            
            .chat-input {
                font-size: 0.9rem;
                padding: 8px 12px; /* Reduced padding */
                min-height: 32px; /* Shorter input */
            }
        }

        @media (max-width: 320px) {
            .container { padding: 65px 10px 10px 10px; } /* Adjusted for very small header */
            .header { 
                padding: 10px 15px 5px 15px; /* Minimal padding on very small screens */
            }
            .header-icon {
                width: 40px; /* Very small icon */
                height: 40px;
                margin: 0 auto 5px;
            }
            .header h1 { font-size: 1.1rem; }
            .header p { font-size: 0.75rem; }
            .chat-input-container {
                width: calc(100% - 20px);
                bottom: 20px;
                padding: 8px; /* Minimal padding */
                min-height: 40px; /* Very short chatbox */
                border-radius: 8px; /* Very small rounded corners */
            }
            
            /* Mobile keyboard adjustments for very small screens */
            .chat-input-container.keyboard-open {
                bottom: 2px;
                transform: translateX(-50%) translateY(-2px);
            }
            
            .chat-input-wrapper {
                gap: 6px; /* Minimal gap */
            }
            .send-button {
                width: 32px; /* Very small button */
                height: 32px;
            }
            .send-button svg {
                width: 12px; /* Very small icon */
                height: 12px;
            }
            .upload-button {
                width: 32px; /* Match send button size */
                height: 32px;
            }
            .upload-button svg {
                width: 12px; /* Match send button icon size */
                height: 12px;
            }
            .chat-messages {
                width: calc(100% - 20px);
                max-height: 100vh; /* Full viewport height */
                top: 0; /* Start from top of screen */
                padding: 65px 20px 140px 0; /* Increased bottom padding for better spacing */
                /* Hide scrollbar on mobile */
                -webkit-scrollbar: none;
                -ms-overflow-style: none;  /* IE and Edge */
                scrollbar-width: none;  /* Firefox */
            }

            /* Additional scrollbar hiding for webkit browsers */
            .chat-messages::-webkit-scrollbar {
                display: none;
            }
            
            .chat-input {
                font-size: 0.85rem;
                padding: 6px 10px; /* Minimal padding */
                min-height: 28px; /* Very short input */
            }
        }

        /* Additional mobile optimizations */
        @media (max-width: 768px) {
            .container { padding: 100px 10px 10px 10px; } /* Adjusted for smaller header */
            .header { 
                padding: 20px 20px 10px 20px; /* Reduced vertical padding */
            }
            .header-icon {
                width: 60px; /* Smaller icon */
                height: 60px;
                margin: 0 auto 10px; /* Reduced bottom margin */
            }
            .header h1 { font-size: 1.4rem; } /* Smaller title */
            .header p { font-size: 0.85rem; } /* Smaller subtitle */
            .message-content { max-width: 85%; }
            .chat-messages {
                width: 90%;
                max-height: 100vh; /* Full viewport height */
                padding: 100px 20px 180px 0; /* Increased bottom padding for better spacing */
                top: 0; /* Start from top of screen */
                /* Hide scrollbar on mobile */
                -webkit-scrollbar: none;
                -ms-overflow-style: none;  /* IE and Edge */
                scrollbar-width: none;  /* Firefox */
            }

            /* Additional scrollbar hiding for webkit browsers */
            .chat-messages::-webkit-scrollbar {
                display: none;
            }
            .chat-input-container {
                width: 90%;
                bottom: 40px; /* Reduced bottom spacing */
                padding: 12px; /* Smaller padding */
                min-height: 50px; /* Shorter chatbox */
                border-radius: 12px; /* Smaller rounded corners */
            }
            
            /* Mobile keyboard adjustments */
            .chat-input-container.keyboard-open {
                bottom: 10px;
                transform: translateX(-50%) translateY(-5px);
            }
            
            .chat-input-wrapper {
                gap: 10px; /* Reduced gap between input and button */
            }
            .send-button {
                width: 40px; /* Smaller button */
                height: 40px;
            }
            .upload-button {
                width: 40px; /* Match send button size */
                height: 40px;
            }
            .send-button svg {
                width: 16px; /* Smaller icon */
                height: 16px;
            }
            .upload-button svg {
                width: 16px; /* Match send button icon size */
                height: 16px;
            }
            .chat-input {
                min-height: 36px; /* Shorter input field */
                padding: 8px 12px; /* Reduced padding */
            }
        }

        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: #666666;
            font-family: 'Courier New', monospace;
            position: relative;
        }

        .welcome-message::before {
            content: '>';
            position: absolute;
            left: 10px;
            top: 20px;
            color: #000000;
            font-size: 1.2rem;
            animation: cursorBlink 1s infinite;
        }

        .welcome-message::after {
            content: '';
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 1px;
            background: linear-gradient(90deg, transparent, #000000, transparent);
        }

        @keyframes cursorBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .welcome-message h3 {
            margin-bottom: 15px;
            color: #000000;
            font-size: 1.3rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 12px rgba(0, 0, 0, 0.6);
        }

        .welcome-message p {
            line-height: 1.6;
            margin-bottom: 10px;
            font-size: 1rem;
            opacity: 0.8;
        }

        /* Fullscreen video overlay */
        .video-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: black;
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .video-overlay.show {
            display: flex;
        }

        .fullscreen-video {
            width: 100vw;
            height: 100vh;
            object-fit: cover;
        }

        /* Mobile-specific styles for video overlay */
        @media (max-width: 768px) {
            .video-overlay {
                /* Ensure overlay covers full screen on mobile */
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100vw;
                height: 100vh;
                /* Prevent mobile browser UI from interfering */
                -webkit-transform: translateZ(0);
                transform: translateZ(0);
            }

            .fullscreen-video {
                width: 100vw;
                height: 100vh;
                object-fit: cover;
                /* Force hardware acceleration on mobile */
                -webkit-transform: translateZ(0);
                transform: translateZ(0);
            }

            .video-close-button {
                /* Make close button more accessible on mobile */
                top: 10px;
                right: 10px;
                width: 50px;
                height: 50px;
                font-size: 2rem;
                /* Ensure button is above everything */
                z-index: 10001;
                /* Better touch target */
                min-width: 44px;
                min-height: 44px;
            }
        }

        /* iOS Safari specific fixes */
        @supports (-webkit-appearance: none) {
            .fullscreen-video {
                /* Fix for iOS Safari video display issues */
                -webkit-transform: translate3d(0, 0, 0);
                transform: translate3d(0, 0, 0);
            }
        }

        .video-close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 24px;
            color: black;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .video-close-button:hover {
            background: rgba(255, 255, 255, 1);
        }



        /* Hide header logo during animation */
        .header-icon.hidden {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        /* New chat button */
        .new-chat-button {
            position: fixed;
            top: 20px;
            right: 10%; /* Align with right edge of 80% width chatbox (90% - 80% = 10% from right) */
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px) saturate(1.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .new-chat-button:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .new-chat-button svg {
            width: 20px;
            height: 20px;
            color: rgba(0, 0, 0, 0.7);
            transition: color 0.3s ease;
        }

        .new-chat-button:hover svg {
            color: rgba(0, 0, 0, 0.9);
        }

        /* Responsive positioning for new chat button to match chatbox */
        @media (max-width: 1200px) {
            .new-chat-button {
                right: 7.5%; /* Match 85% width chatbox */
            }
        }

        @media (max-width: 768px) {
            .new-chat-button {
                right: 5%; /* Match 90% width chatbox */
            }
        }

        @media (max-width: 480px) {
            .new-chat-button {
                right: 2.5%; /* Match 95% width chatbox */
            }
        }

        @media (max-width: 320px) {
            .new-chat-button {
                right: 10px; /* Match calc(100% - 20px) width chatbox */
            }
        }
    </style>
</head>
<body>
    <!-- Circuit pattern overlay for chat -->
    <div class="circuit-pattern-chat"></div>

    <!-- Video overlay -->
    <div class="video-overlay" id="videoOverlay">
        <button class="video-close-button" onclick="closeVideo()" title="Close video">×</button>
        <video class="fullscreen-video" id="fullscreenVideo" autoplay loop muted playsinline webkit-playsinline>
            <source src="/static/liamaicreepy.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>

    <div class="container">


        <!-- New chat button -->
        <button class="new-chat-button" onclick="startNewChat()" title="New Chat">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 5v14"/>
                <path d="M5 12h14"/>
            </svg>
        </button>

        <div class="header">
            <img src="/static/liamai_cropped.png" alt="Liam Icon" class="header-icon">
        </div>

        <div class="chat-messages" id="chatMessages">
            
        </div>

        <div class="chat-input-container">
                <!-- Image Preview -->
                <div class="image-preview-container" id="imagePreview">
                    <img id="previewImage" class="image-preview-img" alt="Preview" onclick="clearImage()" title="Click to remove">
                </div>

                <div class="chat-input-wrapper">
                    <textarea
                        id="chatInput"
                        class="chat-input"
                        placeholder="Hi, *giggles* I'm Liam"
                        rows="1"
                    ></textarea>
                    <button id="uploadButton" class="upload-button" onclick="triggerFileUpload()" title="Upload Image">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect width="18" height="18" x="3" y="3" rx="2" ry="2"/>
                            <circle cx="9" cy="9" r="2"/>
                            <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
                        </svg>
                    </button>
                    <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
                    <button id="sendButton" class="send-button" onclick="sendMessage()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="m22 2-7 20-4-9-9-4 20-7z"/>
                            <path d="M22 2 11 13"/>
                        </svg>
                    </button>
                </div>
            </div>
    </div>

    <script>
        let isTyping = false;
        let selectedImage = null;

        // Auto-resize textarea
        const chatInput = document.getElementById('chatInput');
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Basic mobile keyboard handling removed to restore functionality

        // Enter key to send
        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

                // Simple button event handling - let HTML onclick handle it

        // Image upload functions
        function triggerFileUpload() {
            document.getElementById('fileInput').click();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    alert('Please select an image file');
                    return;
                }

                // Validate supported formats for OpenAI Vision
                const supportedFormats = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                if (!supportedFormats.includes(file.type)) {
                    alert('Please use JPEG, PNG, GIF, or WebP format images');
                    return;
                }

                // Validate file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    alert('File size must be less than 10MB');
                    return;
                }

                // Validate file size for OpenAI Vision (max 20MB for GPT-4o)
                if (file.size > 20 * 1024 * 1024) {
                    alert('File size must be less than 20MB for vision analysis');
                    return;
                }

                selectedImage = file;

                // Update upload button to show it has an image
                const uploadButton = document.getElementById('uploadButton');
                uploadButton.classList.add('has-image');

                // Show image preview
                showImagePreview(file);

                // Show success feedback
                console.log('Image selected:', file.name);
            }
        }

        function showImagePreview(file) {
            const previewContainer = document.getElementById('imagePreview');
            const previewImage = document.getElementById('previewImage');

            // Create object URL for preview
            const objectUrl = URL.createObjectURL(file);
            previewImage.src = objectUrl;

            // Show preview
            previewContainer.classList.add('show');
        }

        function hideImagePreview() {
            const previewContainer = document.getElementById('imagePreview');
            const previewImage = document.getElementById('previewImage');

            // Revoke object URL to free memory
            if (previewImage.src.startsWith('blob:')) {
                URL.revokeObjectURL(previewImage.src);
            }

            // Hide preview
            previewContainer.classList.remove('show');
        }


        function clearImage() {
            selectedImage = null;
            document.getElementById('fileInput').value = '';
            const uploadButton = document.getElementById('uploadButton');
            uploadButton.classList.remove('has-image');

            // Hide image preview
            hideImagePreview();
        }

        // Cyber-themed initialization
        console.log('NEURAL INTERFACE INITIALIZED');

        // Enhanced scrolling function to ensure proper spacing
        function ensureProperScrolling() {
            const messagesContainer = document.getElementById('chatMessages');
            if (messagesContainer) {
                // Scroll to bottom with extra buffer for proper spacing
                messagesContainer.scrollTop = messagesContainer.scrollHeight + 100;
                
                // Double-check after a brief delay for dynamic content
                setTimeout(() => {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight + 100;
                }, 50);
            }
        }

        // Header fade effect on scroll
        const header = document.querySelector('.header');
        const chatMessages = document.getElementById('chatMessages');
        
        function handleScroll() {
            const scrollTop = chatMessages.scrollTop;
            
            // Add scrolled class when scrolling down
            if (scrollTop > 50) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
        }
        
        // Add scroll listener to chat messages container
        chatMessages.addEventListener('scroll', handleScroll);

        function parseMarkdown(text) {
            // Simple markdown parser
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/### (.*?)(?:\n|$)/g, '<h3>$1</h3>')
                .replace(/## (.*?)(?:\n|$)/g, '<h2>$1</h2>')
                .replace(/- (.*?)(?:\n|$)/g, '<li>$1</li>')
                .replace(/\n/g, '<br>');
        }

        function addMessage(content, isUser = false, ragInfo = null, imageData = null) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;


            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';

            // Handle image display
            if (imageData) {
                const imageContainer = document.createElement('div');
                imageContainer.className = 'message-image-container';

                const image = document.createElement('img');
                image.src = imageData;
                image.className = 'message-image';
                image.alt = 'Uploaded image';
                imageContainer.appendChild(image);

                messageContent.appendChild(imageContainer);
            }

            // Handle text content
            if (content && content.trim()) {
                const textDiv = document.createElement('div');
                // Parse markdown for AI responses
                if (!isUser) {
                    textDiv.innerHTML = parseMarkdown(content);
                } else {
                    textDiv.textContent = content;
                }
                messageContent.appendChild(textDiv);
            }

            // Add re-ask button to user messages
            if (isUser && (content || imageData)) {
                const reaskButton = document.createElement('button');
                reaskButton.className = 'reask-button';
                reaskButton.title = 'Re-ask this question';
                reaskButton.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                        <path d="M21 3v5h-5"/>
                        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                        <path d="M3 21v-5h5"/>
                    </svg>
                `;
                
                // Store the original message data for re-asking
                reaskButton.onclick = () => reaskMessage(content, imageData);
                
                messageContent.appendChild(reaskButton);
            }

            messageDiv.appendChild(messageContent);

            // Source info removed - no more source mentions

            messagesContainer.appendChild(messageDiv);
            
            // Ensure proper scrolling with a slight delay to account for layout
            requestAnimationFrame(() => {
                ensureProperScrolling();
            });
        }


        function showTyping() {
            if (isTyping) return; // Prevent multiple calls
            
            isTyping = true;
            const messagesContainer = document.getElementById('chatMessages');
            
            // Remove any existing typing indicator first
            const existingTyping = document.getElementById('typingIndicator');
            if (existingTyping) {
                existingTyping.remove();
            }
            
            // Create typing indicator dynamically
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.id = 'typingIndicator';
            typingIndicator.innerHTML = `
                <div class="message assistant">
                    <div class="message-content">
                        <span>*giggles*</span>
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add to messages container (after the last message)
            messagesContainer.appendChild(typingIndicator);
            
            // Wait for DOM to update before scrolling
            requestAnimationFrame(() => {
                ensureProperScrolling();
            });
        }

        function hideTyping() {
            if (!isTyping) return; // Prevent multiple calls
            
            isTyping = false;
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                // Fade out smoothly before removing
                typingIndicator.style.opacity = '0';
                typingIndicator.style.transition = 'opacity 0.3s ease-out';
                
                // Use a more reliable removal method
                setTimeout(() => {
                    if (typingIndicator && typingIndicator.parentNode) {
                        typingIndicator.remove();
                    }
                }, 300);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if ((!message && !selectedImage) || isTyping) return;

            // Hide image preview immediately when sending
            if (selectedImage) {
                hideImagePreview();
            }

            // Add user message with image if present
            if (selectedImage) {
                // For user messages with images, create a data URL
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageDataUrl = e.target.result;
                    addMessage(message, true, null, imageDataUrl);
                };
                reader.readAsDataURL(selectedImage);
            } else {
                addMessage(message, true);
            }

            // Clear input
            input.value = '';
            input.style.height = 'auto';

            // Close mobile keyboard
            input.blur();

            // Show typing indicator
            showTyping();

            // Prepare data to send
            let requestData = { message: message };
            let headers = {
                'Content-Type': 'application/json',
            };

            // If we have an image, convert it to base64 and include it
            if (selectedImage) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Image = e.target.result;
                    requestData.image = base64Image;
                    requestData.image_name = selectedImage.name;
                    console.log('Sending image data:', {
                        hasImage: !!base64Image,
                        imageSize: base64Image ? base64Image.length : 0,
                        imageName: selectedImage.name,
                        message: message
                    });
                    sendRequest(requestData, headers);
                };
                reader.readAsDataURL(selectedImage);
                return; // Exit early, sendRequest will be called in the onload callback
            }

            // If no image, send directly
            sendRequest(requestData, headers);
        }

        async function sendRequest(requestData, headers) {
            // Disable send button
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();

                if (response.ok) {
                    addMessage(data.response, false);

                    // Check if this is a video trigger response
                    if (data.trigger_video) {
                        setTimeout(() => {
                            showVideo();
                        }, 500);
                    }

                    // Clear the uploaded image after successful send
                    if (selectedImage) {
                        clearImage();
                    }
                } else {
                    addMessage(`Error: ${data.error}`, false);
                }
            } catch (error) {
                addMessage(`Network error: ${error.message}`, false);
            } finally {
                setTimeout(() => {
                    hideTyping();
                    sendButton.disabled = false;
                    // Don't refocus input - keep keyboard closed
                }, 100);
            }
        }



        


        // Video control functions
        function showVideo() {
            const videoOverlay = document.getElementById('videoOverlay');
            const video = document.getElementById('fullscreenVideo');
            
            videoOverlay.classList.add('show');
            
            // Handle mobile autoplay restrictions
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                // For mobile devices, try to play with sound first
                video.muted = false;
                video.volume = 1.0;
                
                const playPromise = video.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        // Video started playing successfully with sound
                        console.log('Video playing with sound on mobile');
                    }).catch(error => {
                        // Autoplay with sound was prevented, try muted autoplay
                        console.log('Autoplay with sound blocked, trying muted:', error);
                        video.muted = true;
                        video.play().then(() => {
                            // Show a tap-to-unmute overlay
                            showTapToUnmute();
                        }).catch(mutedError => {
                            console.log('Even muted autoplay failed:', mutedError);
                            // Force play on next user interaction
                            document.addEventListener('touchstart', forceVideoPlay, { once: true });
                            document.addEventListener('click', forceVideoPlay, { once: true });
                        });
                    });
                }
            } else {
                // Desktop - should work normally
                video.muted = false;
                video.volume = 1.0;
                video.play().catch(error => {
                    console.log('Desktop video play failed:', error);
                });
            }
            
            // Prevent scrolling while video is playing
            document.body.style.overflow = 'hidden';
        }

        function forceVideoPlay() {
            const video = document.getElementById('fullscreenVideo');
            video.muted = false;
            video.volume = 1.0;
            video.play().catch(error => {
                console.log('Force play failed:', error);
            });
            hideTapToUnmute();
        }

        function showTapToUnmute() {
            let tapOverlay = document.getElementById('tapToUnmute');
            if (!tapOverlay) {
                tapOverlay = document.createElement('div');
                tapOverlay.id = 'tapToUnmute';
                tapOverlay.innerHTML = '<div class="tap-message">Tap anywhere to unmute</div>';
                tapOverlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(0, 0, 0, 0.7);
                    z-index: 10000;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    color: white;
                    font-size: 1.5rem;
                    text-align: center;
                    cursor: pointer;
                `;
                tapOverlay.addEventListener('click', () => {
                    forceVideoPlay();
                });
                tapOverlay.addEventListener('touchstart', () => {
                    forceVideoPlay();
                });
                document.body.appendChild(tapOverlay);
            }
        }

        function hideTapToUnmute() {
            const tapOverlay = document.getElementById('tapToUnmute');
            if (tapOverlay) {
                tapOverlay.remove();
            }
        }

        function closeVideo() {
            const videoOverlay = document.getElementById('videoOverlay');
            const video = document.getElementById('fullscreenVideo');
            
            videoOverlay.classList.remove('show');
            video.pause();
            video.currentTime = 0; // Reset video to beginning
            
            // Clean up tap-to-unmute overlay if it exists
            hideTapToUnmute();
            
            // Re-enable scrolling
            document.body.style.overflow = 'auto';
        }

        // Close video on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeVideo();
            }
        });

        // Cyber interface initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('CYBER INTERFACE LOADED');
            // Add any cyber-themed initialization here
        });

        // Re-ask message function
        async function reaskMessage(originalMessage, originalImageData) {
            if (isTyping) return; // Don't allow re-ask while typing
            
            // Add the original message as a new user message
            addMessage(originalMessage, true, null, originalImageData);
            
            // Show typing indicator
            showTyping();
            
            // Prepare data to send (same as sendMessage function)
            let requestData = { message: originalMessage || '' };
            let headers = {
                'Content-Type': 'application/json',
            };
            
            // If there was image data, we need to convert it back to the right format
            if (originalImageData) {
                requestData.image = originalImageData;
                requestData.image_name = 'reask_image.jpg'; // Generic name for re-asked images
            }
            
            // Send the request
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();

                if (response.ok) {
                    addMessage(data.response, false);

                    // Check if this is a video trigger response
                    if (data.trigger_video) {
                        setTimeout(() => {
                            showVideo();
                        }, 500);
                    }
                } else {
                    addMessage(`Error: ${data.error}`, false);
                }
            } catch (error) {
                addMessage(`Network error: ${error.message}`, false);
            } finally {
                setTimeout(() => {
                    hideTyping();
                    sendButton.disabled = false;
                }, 100);
            }
        }

        // New chat function
        function startNewChat() {
            // Clear all messages
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
            
            // Reset input
            const input = document.getElementById('chatInput');
            input.value = '';
            input.focus();
            
            // Reset typing state
            isTyping = false;
            hideTyping();
        }

    </script>
</body>
</html>
